\chapter{Инфраструктура разработки}
\section{Поддержка расширений}
В Ярославской лаборатории FRUCT, Redmine установлен на сервер c операционной
системой Debian. Установка была произведена с помощью системы управления
пакетами, через которую также происходит обновление. Особенностью обновлений
является то, что система управления пакетами полностью перезаписывает всё
содержимое каталога с Redmine, а значит при каждом обновлении необходимо заново
устанавливать все расширения. В настоящий момент в Redmine установлено 7
плагинов и 15 патчей, что делает процесс обновления трудозатратным.
Следовательно необходимо автоматизировать процесс установки расширений.
\inspicture{redmine-update}{Процесс обновления Redmine}{0.6}
Следующие проблемы при обновлений возникает из-за несовместимости плагинов и
патчей с новой версией приложения:
\begin{itemize}
  \item патч не применяется из-за изменения исходных кодов;
  \item плагин некорректно работает.
\end{itemize}
На рисунке \ref{picture:redmine-update} приведены шаги, включающие процесс
обновления. Как видно из рисунка, следствием обновления приложения будет
внесение изменений в плагины и патчи. Необходимо внедрить инструменты
позволяющие вести разработку и поддержку данных расширений.

\subsection{Mercurial Queues}
Mercurial Queues (MQ) \cite{mq} "--- это расширение для системы контроля версий
Mercurial, которое позволяет автоматизировать операции, связанные с поддержкой
патчей. Как показано на рисунке \ref{picture:mq-repo}, MQ хранит патчи в
репозитории, расположенном внутри метаданных родительского репозитория. MQ
хранит список всех патчей в файле \textit{series} (часть файла опущена):
\small{\begin{lstlisting}
wiki_external_filter_plugin.patch
wiki_formatting_routine.patch
fruct_logo.patch
\end{lstlisting}}
\inspicture{mq-repo}{Устройство Mercurial Queues}{0.4}
Работа с патчами в MQ организована в виде стеке и в файле series определён
порядок помещения файлов в стек. Команда \textit{hg qpush} помещает патч на
вершину стека и таким образом применяет его, а точнее, записывает патч как
коммит в родительский репозиторий, см. рисунок \ref{picture:mq-repo}. Команда
\textit{hg qpop} снимает патч, находящийся на вершине стека. MQ отслеживает
применённые патчи, то есть текущее состояние стека, и хранит их список в файле
\textit{status}:
\small{\begin{lstlisting}
937b07ba19ea9d98c9e3433e5ba535bc64ddecaf:wiki_external_filter_plugin.patch
7c32cb90bb7f23cfdb9d60a130cc3a11ef426814:wiki_formatting_routine.patch
\end{lstlisting}}
Каждый патч характеризуется названием, расположенным после двоеточия, и
идентификатором связанного с ним коммита в родительском репозитории.
Расширение MQ предоставляет множество команд для управления патчами, основные
из них:
\begin{itemize}
  \item \textit{qnew} создание патча;
  \item \textit{qpop} снятие патча;
  \item \textit{qpush} применение патча;
  \item \textit{qdiff} просмотр изменений, вносимых патчем;
  \item \textit{qrefresh} сохранение изменений в патч;
  \item \textit{qcommit} сохранение изменений в репозиторий патчей;
  \item \textit{qfinish} оформить патч, как коммит.
\end{itemize}

\subsection{Управление патчами}
Для того, чтобы использовать MQ был создан репозиторий внутри
установочной директории Redmine. Метаданные репозитория хранятся в папке
\textit{.hg} и не затрагиваются обновлением приложения. В репозиторий
были добавлены файлы, к которым будут применятся патчи. Затем был
инициализирован MQ репозиторий командой \textit{hq init --mq}.

Все патчи были занесены MQ репозиторий и плагины были также оформлены в виде
патчей для того, чтобы автоматизировать процесс их установки.
Автоматизированный процесс обновления приложения показан на рисунке
\ref{picture:mq-workflow}. Описать его можно следующим образом: сначала
снимаются все патчи, с помощью команды \textit{hg qpop -a}, затем приложение
обновляется и все патчи применяются с помощью команды \textit{hg qpush -a}. С
помощью данного подхода удалось отказаться от ручной установки плагинов и
применения патчей с помощью утилиты textit{patch}.

При обновлении Redmine некоторые расширения могут стать неработоспособными и
потребовать внесения изменений. Был внедрён процесс, показанный на рисунке
\ref{picture:mq-workflow}, позволяющий эффективно осуществлять поддержку
расширений при обновлениях. Процесс внесения изменений при неисправном патче
описывается следующим образом: необходимо извлечь неработающий патч на вершину
стека с помощью команды \textit{hg qpop <имя\_патча>}, внести изменения в
исходные коды приложения и по окончании записать изменения в файл патча с
помощью команды \textit{hg qrefresh}. Поскольку патчи хранятся в MQ
репозитории, то следующим шагом следует выполнить коммит командой \textit{hg
qcommit}, чтобы зафиксировать изменения.

\inspicture{mq-workflow}{Работа с Mercurial Queues}{1}
С помощью инструмента MQ была автоматизирована установка плагинов и патчей, а
также данный нструмент был успешно внедрён в процесс разработки расширений,
что позволило снизить трудозатраты на поддержку расширений при обновлениях
Redmine.

% \section{Метрики расширений}


\section{Отчёт по возврату наработок сообществу}
Привлечение пользователей 
привлечение разработчиков
  Тестирование
  Отзывы/пожелания
  Разработка
\inspicture{opensource-feedback}{Взаимодействие с сообществом}{0.4}


\paragraph{Ограничение доступа к вики-страницам.}

http://www.redmine.org/plugins/private\_wiki

\paragraph{Ограничение доступа к репозиториям.}
Требуется перевести на 1.4 и 2.0

\paragraph{Рассылка уведомлений о задачах.}
Плагин 

\paragraph{Механизм позиционирования календаря.}
Патч был размещён в баг-трекере официального сайта Redmine задачей под номером
11021. В течении ближайшего времени он будет рассмотрен и принят в кодовую базу
Redmine.

\paragraph{Изображения-ссылки в боковой панели.}
Плагин помещает изображения-ссылки в боковую панель без возможности настройки
изображений и ссылок через интерфейс Redmine. Планируется доработать плагин,
дав возможность пользователю производить редактирование содержания, и выложить
доработанный плагин на официальный сайт Redmine.

\paragraph{Тип задачи при составлении обзора кода.}
Принят
% https://bitbucket.org/haru_iida/redmine_code_review/pull-request/2/allow-selecting-tracker-when-creating-code


%%% Local Variables: 
%%% mode: latex
%%% TeX-PDF-mode: t
%%% TeX-master: "diploma"
%%% End: 
